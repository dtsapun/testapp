<!DOCTYPE html>
<html lang="uk">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Project DIMA</title>
<style>
  body { font-family: monospace; background: #f7f7f7; margin:0; padding:0; }
   #container {
    transform: scale(1.15);
    transform-origin: top left;
  }
  #container { background:#fff; border:1px solid #ccc; border-radius:4px; padding:5px; display:inline-block; }
  .topRow { display:flex; align-items:stretch; gap:5px; }
  .clickers { display:flex; gap:3px; align-items:stretch; flex-direction:column; }
  .clickerRow { display:flex; gap:3px; }
  .col { position:relative; }
  .col button { width:70px; padding:6px; font-size:13px; cursor:pointer; }
  .badge {
    position:absolute;
    top:-8px;
    right:-8px;
    background:#ddd;
    color:#000;
    border-radius:50%;
    padding:2px 6px;
    font-size:12px;
    min-width:8px;
    text-align:center;
    cursor:pointer;
    box-shadow:0 0 2px rgba(0,0,0,0.5);
  }
  .badge input {
    width:20px;
    font-size:12px;
    border:none;
    background:transparent;
    text-align:left;
    outline:none;
  }
  .statsRow {
  display: flex;
  justify-content: space-between;
  align-items: left;
  margin-top: 2px;
  font-size: 16px; /* можна збільшити до 16px, якщо місця вистачить */
  font-weight: bold;
}

.statsRow > div {
  flex: 1;
  text-align: left;
}

  #totalsRow { display:flex; align-items:center; gap:3px; background:#fafafa; border:1px solid #ccc; padding:3px; border-radius:4px; font-size:12px; }
  .totalsLeft { display:flex; flex-direction:column; gap:3px; align-items:center; }
  #stopwatchSmall { font-size:20px; font-weight:1000; min-width:60px; height:24px; line-height:28px; text-align:center; }
  #pauseSmall { font-size:11px; padding:3px 11px; height:19px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px; }
  .totalsRight { display:flex; flex-direction:column; gap:3px; align-items:stretch; height:100%; justify-content:center; }
  .rightTop { display:flex; gap:4px; }
  #resetAll, #toggleStopwatch { flex:1; font-size:12px; padding:3px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px; text-align:center; }
  #toggleTotp { font-size:11px; padding:3px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px; }
  #totpContainer { margin-top:6px; border-top:1px solid #ddd; padding-top:6px; display:none; }
  #totpSecret { width:100%; padding:5px; box-sizing:border-box; font-family:monospace; font-size:12px; }
  #totpCode { margin-top:4px; font-family:monospace; font-size:16px; font-weight:700; letter-spacing:4px; text-align:center; padding:4px; border-radius:4px; border:1px dashed #ddd; cursor:pointer; user-select:none; }
  #totpTimer { font-size:11px; text-align:center; margin-top:4px; color:#333; }
  /* Прибирає стрілочки в Chrome, Edge, Safari */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Прибирає стрілочки у Firefox */
input[type=number] {
  -moz-appearance: textfield;
}
</style>
</head>
<body>
<div id="container">
  <div class="topRow">
    <div class="clickers">
      <div class="clickerRow">
        <div class="col">
          <button id="btn1">VID</button>
          <div id="badge1" class="badge">0</div>
        </div>
        <div class="col">
          <button id="btn2">COM</button>
          <div id="badge2" class="badge">0</div>
        </div>
        <div class="col">
          <button id="btn3">POST</button>
          <div id="badge3" class="badge">0</div>
        </div>
      </div>
      <div class="statsRow">
        <div id="percentStat">0%</div>
        <div id="sumStat">Σ0</div>
      </div>
    </div>
    <div id="totalsRow">
      <div class="totalsLeft">
        <div id="stopwatchSmall">00:00</div>
        <button id="pauseSmall">Pause</button>
      </div>
      <div class="totalsRight">
        <div class="rightTop" id="controlsRow">
          <button id="resetAll">Reset</button>
          <button id="toggleStopwatch">⏱</button>
        </div>
        <button id="toggleTotp">TOTP</button>
      </div>
    </div>
  </div>
  <div id="totpContainer">
    <input id="totpSecret" placeholder="Secret code">
    <div id="totpCode">------</div>
    <div id="totpTimer"></div>
  </div>
</div>

<script>
(function(){
  const w1=0.83,w2=0.2,w3=0.4;
  let swStart=null,swElapsed=0,swRunning=false,swInterval=null;

  const badgeEls=[
    document.getElementById('badge1'),
    document.getElementById('badge2'),
    document.getElementById('badge3')
  ];
  let counts=[0,0,0];

  const percentStat=document.getElementById('percentStat');
  const sumStat=document.getElementById('sumStat');
  const stopwatchSmall=document.getElementById('stopwatchSmall');
  const pauseSmall=document.getElementById('pauseSmall');
  const resetAll=document.getElementById('resetAll');
  const toggleStopwatch=document.getElementById('toggleStopwatch');
  const controlsRow=document.getElementById('controlsRow');
  const toggleTotp=document.getElementById('toggleTotp');
  const totpContainer=document.getElementById('totpContainer');
  const totpSecret=document.getElementById('totpSecret');
  const totpCode=document.getElementById('totpCode');
  const totpTimer=document.getElementById('totpTimer');

  function fmt(ms){const s=Math.floor(ms/1000);return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}
  function updateStopwatchDisplay(){stopwatchSmall.textContent=fmt(swRunning?(Date.now()-swStart):swElapsed);}
  function startStopwatch(){swStart=Date.now()-swElapsed;swRunning=true;clearInterval(swInterval);swInterval=setInterval(updateStopwatchDisplay,250);updateStopwatchDisplay();saveState();}
  function pauseStopwatch(){swElapsed=swRunning?(Date.now()-swStart):swElapsed;swRunning=false;clearInterval(swInterval);updateStopwatchDisplay();saveState();}

  function updateStats(){
    const percent=((counts[0]*w1)+(counts[1]*w2)+(counts[2]*w3)).toFixed(2);
    const sum=counts.reduce((a,b)=>a+b,0);
    percentStat.textContent=percent+'%';
    sumStat.textContent='Σ'+sum;
    saveState();
  }

  function makeEditableBadge(i){
    const badge=badgeEls[i];
    badge.onclick=()=>{
      const inp=document.createElement('input');
      inp.type='number';
      inp.value=counts[i];
      badge.innerHTML='';
      badge.appendChild(inp);
      inp.focus();
      inp.onblur=()=>{
        counts[i]=+inp.value||0;
        badge.textContent=counts[i];
        updateStats();
      };
    };
  }

  badgeEls.forEach((b,i)=>makeEditableBadge(i));

  document.getElementById('btn1').onclick=()=>{counts[0]++;badgeEls[0].textContent=counts[0];updateStats();startStopwatch();};
  document.getElementById('btn2').onclick=()=>{counts[1]++;badgeEls[1].textContent=counts[1];updateStats();startStopwatch();};
  document.getElementById('btn3').onclick=()=>{counts[2]++;badgeEls[2].textContent=counts[2];updateStats();startStopwatch();};

  // Кнопка Pause тепер скидає на нуль
pauseSmall.onclick = () => {
  swRunning = false;
  swElapsed = 0;
  clearInterval(swInterval);
  updateStopwatchDisplay();
  saveState();
};

// Кнопка Reset теж скидає секундомір
resetAll.onclick = () => {
  // обнуляємо кліки
  counts = [0, 0, 0];
  badgeEls.forEach((b, i) => b.textContent = 0);

  // скидаємо секундомір
  swRunning = false;
  swElapsed = 0;
  clearInterval(swInterval);
  updateStopwatchDisplay();

  // оновлюємо статистику і зберігаємо
  updateStats();
  saveState();
};


  toggleStopwatch.onclick=()=>{
    const visible=toggleStopwatch.dataset.visible==="true";
    toggleStopwatch.dataset.visible=(!visible).toString();
    stopwatchSmall.style.display=pauseSmall.style.display=visible?"none":"block";
    controlsRow.style.justifyContent=visible?"flex-start":"";
    saveState();
  };

  // --- TOTP ---
  function base32ToHex(base32){
    const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let bits="",hex="";
    base32=(base32||"").replace(/\s+/g,'').replace(/=+$/,'').toUpperCase();
    for(const ch of base32){const idx=alphabet.indexOf(ch);if(idx<0)return null;bits+=idx.toString(2).padStart(5,'0');}
    for(let i=0;i+4<=bits.length;i+=4)hex+=parseInt(bits.substr(i,4),2).toString(16);
    return hex;
  }
  function hexToBytes(hex){const arr=new Uint8Array(hex.length/2);for(let i=0;i<arr.length;i++)arr[i]=parseInt(hex.substr(i*2,2),16);return arr;}
  async function hmacSha1(kHex,mHex){const key=await crypto.subtle.importKey("raw",hexToBytes(kHex),{name:"HMAC",hash:"SHA-1"},false,["sign"]);return new Uint8Array(await crypto.subtle.sign("HMAC",key,hexToBytes(mHex)));}
  async function generateTOTP(secret,step=30){
    const kHex=base32ToHex(secret);if(!kHex)return null;
    const epoch=Math.floor(Date.now()/1000);
    const t=Math.floor(epoch/step);
    const tHex=t.toString(16).padStart(16,'0');
    const hmac=await hmacSha1(kHex,tHex);
    const offset=hmac[hmac.length-1]&0xf;
    const code=((hmac[offset]&0x7f)<<24)|((hmac[offset+1]&0xff)<<16)|((hmac[offset+2]&0xff)<<8)|(hmac[offset+3]&0xff);
    return(code%1e6).toString().padStart(6,'0');
  }
  async function updateTotpCode(){
    const s=totpSecret.value.trim();
    if(!s){totpCode.textContent="------";totpTimer.textContent="";return;}
    totpCode.textContent=await generateTOTP(s)||"Error";
  }
  let lastStep=null,totpInterval=null;
  function startTotp(){
    updateTotpCode();
    lastStep=Math.floor(Math.floor(Date.now()/1000)/30);
    totpTimer.textContent=`Update in ${30-(Math.floor(Date.now()/1000)%30)}s`;
    clearInterval(totpInterval);
    totpInterval=setInterval(()=>{
      const epoch=Math.floor(Date.now()/1000);
      const step=Math.floor(epoch/30);
      const left=30-(epoch%30);
      totpTimer.textContent=`Update in ${left}s`;
      if(step!==lastStep){lastStep=step;updateTotpCode();}
    },500);
  }
  function stopTotp(){clearInterval(totpInterval);totpTimer.textContent="";}
  toggleTotp.onclick=()=>{
    const hidden=getComputedStyle(totpContainer).display==='none';
    if(hidden){totpContainer.style.display='block';startTotp();}
    else{totpContainer.style.display='none';stopTotp();}
    saveState();
  };
  totpSecret.addEventListener('input',()=>{updateTotpCode();saveState();});
  totpCode.addEventListener('click',()=>{
    const t=totpCode.textContent.trim();
    if(t&&t!=="------"&&t!=="Error"){
      navigator.clipboard.writeText(t).then(()=>{
        const original=totpCode.textContent;
        totpCode.textContent="Copied!";
        setTimeout(()=>{totpCode.textContent=original;},1000);
      });
    }
  });

  // --- Storage ---
  const KEY='appState_compact';
  function saveState(){
    const elapsed=swRunning?(Date.now()-swStart):swElapsed;
    localStorage.setItem(KEY,JSON.stringify({
      counts,
      totpSecret:totpSecret.value||'',
      totpOpen:getComputedStyle(totpContainer).display!=='none',
      stopwatchVisible:stopwatchSmall.style.display!=='none',
    }));
  }
  function loadState(){
    try{
      const st=JSON.parse(localStorage.getItem(KEY)||'{}');
      if(Array.isArray(st.counts)){counts=st.counts;counts.forEach((v,i)=>badgeEls[i].textContent=v);}
      if(st.totpSecret)totpSecret.value=st.totpSecret;
      const visible=st.stopwatchVisible!==false;
      stopwatchSmall.style.display=pauseSmall.style.display=visible?'block':'none';
      toggleStopwatch.dataset.visible=visible.toString();
      swElapsed=0;
      if(st.totpOpen){totpContainer.style.display='block';startTotp();}
      updateStats();
    }catch(e){}
  }

  loadState();
  updateStopwatchDisplay();
})();
</script>
<script>
// Зберігаємо розмір перед закриттям
window.addEventListener('beforeunload', () => {
  localStorage.setItem('trackerWindowSize', JSON.stringify({
    width: window.outerWidth,
    height: window.outerHeight
  }));
});

// При завантаженні вікна пробуємо змінити його розмір
window.addEventListener('load', () => {
  const savedSize = JSON.parse(localStorage.getItem('trackerWindowSize') || '{}');
  if (savedSize.width && savedSize.height) {
    window.resizeTo(savedSize.width, savedSize.height);
  }
});
</script>

</body>
</html>


